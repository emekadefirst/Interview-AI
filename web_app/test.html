<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Room</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        #chat {
            height: 400px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
        }

        #userInput {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
        }

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    <h1>Interview Room</h1>
    <div>
        <label for="applicantCode">Applicant Code:</label>
        <input type="text" id="applicantCode" required>
        <button onclick="startInterview()">Start Interview</button>
    </div>
    <div id="interviewRoom" style="display:none;">
        <div id="chat"></div>
        <button id="startRecording">Start Recording</button>
        <button id="stopRecording" disabled>Stop Recording</button>
        <audio id="audioPlayback" controls style="display:none;"></audio>
    </div>

    <script>
        let socket;
        let mediaRecorder;
        let audioChunks = [];
        const chat = document.getElementById('chat');
        const startRecordButton = document.getElementById('startRecording');
        const stopRecordButton = document.getElementById('stopRecording');
        const audioPlayback = document.getElementById('audioPlayback');

        function startInterview() {
            const applicantCode = document.getElementById('applicantCode').value;
            if (!applicantCode) {
                alert('Please enter an applicant code');
                return;
            }

            document.getElementById('interviewRoom').style.display = 'block';

            socket = new WebSocket(`ws://127.0.0.1:8000/interview/${applicantCode}`);

            socket.onopen = function (e) {
                console.log("WebSocket connection established");
            };

            socket.onmessage = function (event) {
                const response = JSON.parse(event.data);
                displayMessage('AI', response.text);
                playAudio(response.audio_url);
            };

            socket.onclose = function (event) {
                console.log("WebSocket connection closed");
            };

            socket.onerror = function (error) {
                console.error("WebSocket error:", error);
            };
        }

        function displayMessage(sender, message) {
            const messageElement = document.createElement('p');
            messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }

        function playAudio(audioUrl) {
            audioPlayback.src = audioUrl;
            audioPlayback.playbackRate = 1.75;  // Set playback speed to 1.75x
            audioPlayback.style.display = 'block';
            audioPlayback.play();
        }

        startRecordButton.onclick = async function () {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();

            audioChunks = [];
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            startRecordButton.disabled = true;
            stopRecordButton.disabled = false;
        };

        stopRecordButton.onclick = function () {
            mediaRecorder.stop();
            startRecordButton.disabled = false;
            stopRecordButton.disabled = true;

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                socket.send(await audioBlob.arrayBuffer());
            };
        };
    </script>
</body>

</html>